<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT IDS Management Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #0d1117;
            color: #c9d1d9;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .dashboard-header {
            background: linear-gradient(135deg, #1e3a8a, #7c3aed);
            padding: 20px 0;
            margin-bottom: 30px;
        }
        .card {
            background-color: #161b22;
            border: 1px solid #30363d;
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #21262d;
            border-bottom: 1px solid #30363d;
        }
        .alert-critical { background-color: #dc3545; }
        .alert-high { background-color: #fd7e14; }
        .alert-medium { background-color: #ffc107; color: #000; }
        .alert-low { background-color: #198754; }
        .status-online { color: #28a745; }
        .status-offline { color: #dc3545; }
        .blockchain-block {
            background-color: #21262d;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
            font-family: monospace;
            font-size: 0.9em;
        }
        .attack-item {
            background-color: #21262d;
            border-left: 4px solid #dc3545;
            padding: 10px;
            margin: 5px 0;
            border-radius: 0 8px 8px 0;
        }
        .metric-card {
            text-align: center;
            padding: 20px;
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        .blink {
            animation: blink 1s linear infinite;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-shield-alt"></i> IoT IDS Management Dashboard</h1>
                    <p class="mb-0">Real-time Network Security Monitoring</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-flex align-items-center justify-content-end">
                        <span class="me-2">Status:</span>
                        <span id="monitoring-status" class="status-offline">
                            <i class="fas fa-circle"></i> Offline
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Metrics Row -->
        <div class="row">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-value text-info" id="total-packets">0</div>
                        <div class="metric-label">Total Packets</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-value text-danger" id="malicious-packets">0</div>
                        <div class="metric-label">Malicious Packets</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-value text-success" id="benign-packets">0</div>
                        <div class="metric-label">Benign Packets</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-value text-warning" id="attack-rate">0%</div>
                        <div class="metric-label">Attack Rate</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Real-time Chart -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> Real-time Attack Detection</h5>
                    </div>
                    <div class="card-body">
                        <div id="traffic-chart" style="height: 400px;"></div>
                    </div>
                </div>
            </div>

            <!-- Recent Attacks -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-exclamation-triangle"></i> Recent Attacks</h5>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div id="recent-attacks">
                            <p class="text-muted">No attacks detected yet...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Attack Details -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-list"></i> Attack Details</h5>
                    </div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                        <div id="attack-details">
                            <p class="text-muted">No detailed attack information available...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Blockchain Audit Trail -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-link"></i> Blockchain Audit Trail</h5>
                    </div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                        <div id="blockchain-trail">
                            <p class="text-muted">Loading blockchain...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Information -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle"></i> System Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Model Type:</strong> LightGBM Classifier
                            </div>
                            <div class="col-md-3">
                                <strong>Monitoring Interface:</strong> eth0
                            </div>
                            <div class="col-md-3">
                                <strong>Blockchain Blocks:</strong> <span id="blockchain-count">0</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Last Update:</strong> <span id="last-update">Never</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Update dashboard every 2 seconds
        setInterval(updateDashboard, 2000);
        
        // Initial load
        updateDashboard();
        
        function updateDashboard() {
            // Fetch stats
            $.get('/api/stats', function(data) {
                if (data.error) {
                    console.error('Error:', data.error);
                    return;
                }
                
                // Update metrics
                $('#total-packets').text(data.stats.total);
                $('#malicious-packets').text(data.stats.malicious);
                $('#benign-packets').text(data.stats.benign);
                $('#attack-rate').text(data.stats.attack_rate + '%');
                $('#blockchain-count').text(data.blockchain_blocks);
                $('#last-update').text(new Date().toLocaleTimeString());
                
                // Update monitoring status
                if (data.monitoring_status) {
                    $('#monitoring-status').removeClass('status-offline').addClass('status-online');
                    $('#monitoring-status').html('<i class="fas fa-circle"></i> Online');
                } else {
                    $('#monitoring-status').removeClass('status-online').addClass('status-offline');
                    $('#monitoring-status').html('<i class="fas fa-circle"></i> Offline');
                }
                
                // Update recent attacks
                updateRecentAttacks(data.recent_attacks);
            });
            
            // Update traffic chart
            $.get('/api/traffic_chart', function(chartData) {
                if (Object.keys(chartData).length > 0) {
                    Plotly.newPlot('traffic-chart', chartData.data, chartData.layout, {
                        displayModeBar: false,
                        responsive: true
                    });
                }
            });
            
            // Update blockchain
            $.get('/api/blockchain', function(blocks) {
                updateBlockchain(blocks);
            });
            
            // Update attack details
            $.get('/api/attacks', function(attacks) {
                updateAttackDetails(attacks);
            });
        }
        
        function updateRecentAttacks(attacks) {
            const container = $('#recent-attacks');
            
            if (attacks.length === 0) {
                container.html('<p class="text-muted">No attacks detected yet...</p>');
                return;
            }
            
            let html = '';
            attacks.slice(0, 5).forEach(function(attack) {
                const alertClass = getThreatClass(attack.threat_level);
                html += `
                    <div class="attack-item ${alertClass}">
                        <div class="d-flex justify-content-between">
                            <strong>${attack.attack_type}</strong>
                            <small>${new Date(attack.timestamp).toLocaleTimeString()}</small>
                        </div>
                        <div>
                            <small>From: ${attack.source_ip}</small><br>
                            <small>Threat: ${attack.threat_level} (${(attack.confidence * 100).toFixed(1)}%)</small>
                        </div>
                    </div>
                `;
            });
            
            container.html(html);
        }
        
        function updateAttackDetails(attacks) {
            const container = $('#attack-details');
            
            if (attacks.length === 0) {
                container.html('<p class="text-muted">No detailed attack information available...</p>');
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-dark table-sm">';
            html += '<thead><tr><th>Time</th><th>Type</th><th>Source</th><th>Threat</th><th>Confidence</th></tr></thead><tbody>';
            
            attacks.slice(0, 10).forEach(function(attack) {
                html += `
                    <tr>
                        <td>${new Date(attack.timestamp).toLocaleTimeString()}</td>
                        <td>${attack.attack_type}</td>
                        <td>${attack.source_ip}</td>
                        <td><span class="badge ${getThreatBadge(attack.threat_level)}">${attack.threat_level}</span></td>
                        <td>${(attack.confidence * 100).toFixed(1)}%</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.html(html);
        }
        
        function updateBlockchain(blocks) {
            const container = $('#blockchain-trail');
            
            if (blocks.length === 0) {
                container.html('<p class="text-muted">No blockchain blocks yet...</p>');
                return;
            }
            
            let html = '';
            blocks.slice(-5).reverse().forEach(function(block) {
                html += `
                    <div class="blockchain-block">
                        <div><strong>Block #${block.index}</strong></div>
                        <div><small>Hash: ${block.hash.substring(0, 16)}...</small></div>
                        <div><small>Time: ${new Date(block.timestamp).toLocaleString()}</small></div>
                        <div>${block.data}</div>
                    </div>
                `;
            });
            
            container.html(html);
        }
        
        function getThreatClass(level) {
            switch(level.toLowerCase()) {
                case 'critical': return 'alert-critical blink';
                case 'high': return 'alert-high';
                case 'medium': return 'alert-medium';
                case 'low': return 'alert-low';
                default: return '';
            }
        }
        
        function getThreatBadge(level) {
            switch(level.toLowerCase()) {
                case 'critical': return 'bg-danger';
                case 'high': return 'bg-warning';
                case 'medium': return 'bg-info';
                case 'low': return 'bg-success';
                default: return 'bg-secondary';
            }
        }
    </script>
</body>
</html>
